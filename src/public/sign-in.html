<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In - n8n MCP OAuth</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Sign In to n8n MCP</h1>
      <p class="subtitle">OAuth Authorization Request</p>
    </div>

    <form id="login-form" class="auth-form">
      <div class="form-group">
        <label for="email">Email Address</label>
        <input
          type="email"
          id="email"
          name="email"
          required
          autofocus
          autocomplete="email"
          placeholder="your@email.com"
        >
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input
          type="password"
          id="password"
          name="password"
          required
          autocomplete="current-password"
        >
      </div>

      <button type="submit" class="btn-primary">Sign In</button>

      <div id="error-message" class="error" role="alert"></div>
    </form>
  </div>

  <script>
    // Preserve all OAuth parameters from the URL
    const urlParams = new URLSearchParams(window.location.search);

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorEl = document.getElementById('error-message');

      errorEl.textContent = '';

      try {
        const response = await fetch('/api/auth/sign-in/email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (response.ok) {
          // Check if this is part of an OAuth flow
          if (urlParams.has('client_id')) {
            // Redirect back to OAuth authorize endpoint with all parameters
            const redirectUrl = new URL('/api/auth/oauth2/authorize', window.location.origin);
            // Copy all query parameters
            urlParams.forEach((value, key) => {
              redirectUrl.searchParams.set(key, value);
            });
            window.location.href = redirectUrl.toString();
          } else {
            // Regular sign-in, redirect to home
            window.location.href = '/';
          }
        } else {
          const error = await response.json();
          errorEl.textContent = error.message || 'Invalid email or password';
        }
      } catch (error) {
        errorEl.textContent = 'Network error. Please try again.';
      }
    });
  </script>
</body>
</html>
